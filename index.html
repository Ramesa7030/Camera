<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Asset Capture PWA</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --primary:#4361ee;--secondary:#3f37c9;--success:#4cc9f0;
      --warning:#f72585;--error:#f44336;--dark:#1d3557;--light:#f8f9fa;
    }
    body{
      margin:0;font-family:'Segoe UI',system-ui,sans-serif;
      background:linear-gradient(135deg,#1a2a6c,#b21f1f,#1a2a6c);
      color:var(--light);display:flex;flex-direction:column;min-height:100vh;
      overflow-y:auto;
    }
    .app-header{background:rgba(29,53,87,.85);padding:1rem;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:10}
    .app-title{font-size:1.8rem;font-weight:700;letter-spacing:1px;margin:0;background:linear-gradient(to right,#4cc9f0,#f72585);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .app-container{display:flex;flex-direction:column;flex:1;overflow-y:auto;padding:1rem;max-width:1000px;margin:0 auto;width:100%}
    #cameraContainer{position:relative;border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.3);margin-bottom:1.5rem;background:#000;display:flex;justify-content:center;align-items:center;min-height:250px;aspect-ratio:4/3}
    #view{width:100%;height:100%;object-fit:cover;display:block}
    .camera-placeholder{text-align:center;padding:2rem}
    .camera-placeholder i{font-size:4rem;color:#4cc9f0;margin-bottom:1rem}
    .camera-placeholder h3{font-size:1.8rem;margin-bottom:1rem;color:#f8f9fa}
    .camera-placeholder p{margin-bottom:1.5rem;font-size:1.1rem;max-width:500px;line-height:1.6}
    .controls{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem;flex-wrap:wrap}
    .btn{padding:.9rem 1.8rem;border-radius:50px;border:none;font-weight:600;font-size:1rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:all .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.2);user-select:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:active{transform:scale(.95)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover:not(:disabled){background:var(--secondary)}
    .btn-success{background:var(--success);color:var(--dark)}
    .btn-success:hover:not(:disabled){background:#48bfe3}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-warning:hover:not(:disabled){background:#e71d73}
    .btn-error{background:var(--error);color:#fff}
    .btn-error:hover:not(:disabled){background:#e53935}
    #snap{position:absolute;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#fff;color:#333;border:none;border-radius:50%;width:70px;height:70px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:5;display:flex;align-items:center;justify-content:center;font-size:1.8rem;transition:all .2s ease}
    #snap:hover{transform:translateX(-50%) scale(1.05)}
    #snap:active{transform:translateX(-50%) scale(.95)}
    #formArea{background:rgba(29,53,87,.85);padding:1.5rem;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);display:none;backdrop-filter:blur(10px);margin-top:1rem}
    .form-title{text-align:center;margin-bottom:1.5rem;font-size:1.4rem;color:#4cc9f0}
    .form-group{margin-bottom:1.2rem}
    label{display:block;margin-bottom:.5rem;font-weight:500;font-size:1rem}
    input,textarea{width:100%;padding:.8rem 1rem;border-radius:12px;border:2px solid rgba(76,201,240,.3);background:rgba(255,255,255,.1);color:#fff;font-size:1rem;transition:border-color .3s}
    input:focus,textarea:focus{outline:none;border-color:#4cc9f0}
    input::placeholder,textarea::placeholder{color:rgba(255,255,255,.5)}
    #save{width:100%;padding:1rem;font-size:1.1rem;font-weight:600}
    #msg{text-align:center;margin-top:1rem;font-weight:600;min-height:1.5rem;color:#4cc9f0}
    .export-buttons{position:absolute;top:1rem;right:1rem;display:flex;gap:.8rem}
    .status-bar{display:flex;justify-content:space-between;padding:.8rem 1.5rem;background:rgba(29,53,87,.7);border-radius:50px;margin-top:1.5rem;font-size:.9rem}
    .gps-status,.db-status,.camera-status{display:flex;align-items:center;gap:.5rem}
    .gps-status i,.db-status i,.camera-status i{font-size:1.2rem}
    .gps-active{color:#4ade80}.gps-inactive{color:#f87171}.db-active{color:#60a5fa}.camera-active{color:#4ade80}.camera-inactive{color:#f87171}
    .progress-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:100;display:none}
    .progress-text{color:#fff;font-size:1.5rem;margin-top:1rem}
    .spinner{width:50px;height:50px;border:5px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#4cc9f0;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .counter{font-size:1.2rem;margin-top:1rem;color:#fff}
    .instructions{background:rgba(29,53,87,.7);border-radius:16px;padding:1.5rem;margin-top:1.5rem;font-size:.95rem;line-height:1.6}
    .instructions h3{color:#4cc9f0;margin-bottom:.8rem}
    .instructions ul{padding-left:1.5rem}
    .instructions li{margin-bottom:.5rem}
    .permission-help{background:rgba(244,67,54,.2);border-left:4px solid var(--error);padding:1rem;margin:1rem 0;border-radius:0 8px 8px 0}
    .permission-help h4{color:#ff8a80;margin-bottom:.5rem}
    @media (max-width:768px){
      .app-container{padding:.8rem}
      .controls{flex-direction:column;gap:.8rem}
      .btn{width:100%;justify-content:center}
      .export-buttons{top:.5rem;right:.5rem}
      .status-bar{flex-direction:column;gap:.8rem;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h1 class="app-title"><i class="fas fa-camera"></i> Asset Capture PWA</h1>
  </div>

  <div class="app-container">
    <div id="cameraContainer">
      <video id="view" autoplay playsinline></video>
      <button id="snap"><i class="fas fa-camera"></i></button>

      <div class="export-buttons">
        <button id="exportCSV" class="btn btn-success"><i class="fas fa-file-csv"></i> CSV</button>
        <button id="exportImages" class="btn btn-warning"><i class="fas fa-file-image"></i> Images</button>
      </div>

      <div id="cameraPlaceholder" class="camera-placeholder" style="display:none">
        <i class="fas fa-video-slash"></i>
        <h3>Camera Access Required</h3>
        <p>To use this app, please allow camera access in your browser. The camera is required to capture asset photos.</p>
        <div class="permission-help">
          <h4>How to enable camera access:</h4>
          <ul>
            <li>Look for the camera permission prompt in your browser</li>
            <li>Check your browser's address bar for a camera icon</li>
            <li>Go to browser settings → Privacy → Camera permissions</li>
            <li>Refresh the page after granting permissions</li>
          </ul>
        </div>
        <button id="retryCamera" class="btn btn-error"><i class="fas fa-redo"></i> Retry Camera Access</button>
      </div>
    </div>

    <div class="controls">
      <button id="switchCamera" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Switch Camera</button>
      <button id="toggleFlash" class="btn btn-primary"><i class="fas fa-bolt"></i> Flash: Off</button>
    </div>

    <div class="status-bar">
      <div class="camera-status">
        <i id="cameraIcon" class="fas fa-video camera-inactive"></i>
        <span id="cameraStatus">Camera: Initializing…</span>
      </div>
      <div class="gps-status">
        <i id="gpsIcon" class="fas fa-map-marker-alt gps-inactive"></i>
        <span id="gpsStatus">Acquiring location…</span>
      </div>
      <div class="db-status">
        <i id="dbIcon" class="fas fa-database db-active"></i>
        <span>AssetDB: <span id="recordCount">0</span> records</span>
      </div>
    </div>

    <div id="formArea">
      <h3 class="form-title">Asset Details</h3>
      <div class="form-group">
        <label for="num"><i class="fas fa-hashtag"></i> Asset Number</label>
        <input type="text" required id="num" placeholder="Enter asset number">
      </div>
      <div class="form-group">
        <label for="desc"><i class="fas fa-align-left"></i> Description</label>
        <input type="text" required id="desc" placeholder="Enter description">
      </div>
      <div class="form-group">
        <label for="notes"><i class="fas fa-sticky-note"></i> Notes</label>
        <textarea id="notes" rows="2" placeholder="Additional notes"></textarea>
      </div>
      <button id="save" class="btn btn-success"><i class="fas fa-save"></i> Save & Reset</button>
      <div id="msg"></div>
    </div>

    <div class="instructions">
      <h3><i class="fas fa-info-circle"></i> How to Use</h3>
      <ul>
        <li>Click the camera button to capture an asset photo</li>
        <li>Fill in the asset details and click "Save & Reset"</li>
        <li>Use "Export CSV" to download all asset metadata</li>
        <li>Use "Export Images" to download all captured photos</li>
        <li>Switch between front and rear cameras using "Switch Camera"</li>
      </ul>
    </div>
  </div>

  <div class="progress-overlay" id="progressOverlay">
    <div class="spinner"></div>
    <div class="progress-text" id="progressText">Exporting Images…</div>
    <div class="counter" id="progressCounter">0/0</div>
  </div>

  <script>
    /* ---------- IndexedDB ---------- */
    const dbName = 'AssetDB', storeName = 'assets';
    let db;
    const openDB = () => {
      const req = indexedDB.open(dbName, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(storeName)) {
          const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
          store.createIndex('ts', 'ts');
        }
      };
      req.onsuccess = () => { db = req.result; updateRecordCount(); };
      req.onerror = e => console.error(e);
    };
    openDB();

    function updateRecordCount() {
      if (!db) return;
      const tx = db.transaction([storeName], 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.count();
      req.onsuccess = () => document.getElementById('recordCount').textContent = req.result;
    }

    /* ---------- Camera ---------- */
    const view = document.getElementById('view');
    const snapBtn = document.getElementById('snap');
    const formArea = document.getElementById('formArea');
    const switchBtn = document.getElementById('switchCamera');
    const flashBtn = document.getElementById('toggleFlash');
    const retryBtn = document.getElementById('retryCamera');
    const camIcon = document.getElementById('cameraIcon');
    const camStatus = document.getElementById('cameraStatus');
    let stream = null, facing = 'environment', flashOn = false;

    function updateCamState(text, active) {
      camStatus.textContent = `Camera: ${text}`;
      camIcon.className = active ? 'fas fa-video camera-active' : 'fas fa-video-slash camera-inactive';
    }
    async function initCam(facingMode) {
      updateCamState('Requesting access…', false);
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        stream = s; view.srcObject = s; facing = facingMode;
        s.getVideoTracks()[0].onstart = () => updateCamState('Active', true);
        s.getVideoTracks()[0].onended = () => updateCamState('Disconnected', false);
      } catch (err) {
        updateCamState('Access denied', false);
        document.querySelector('.camera-placeholder p').textContent = err.name === 'NotAllowedError' ? 'Camera permission denied' : err.message;
      }
    }
    initCam(facing);
    switchBtn.addEventListener('click', () => initCam(facing === 'environment' ? 'user' : 'environment'));
    flashBtn.addEventListener('click', () => { flashOn = !flashOn; flashBtn.innerHTML = `<i class="fas fa-bolt"></i> Flash: ${flashOn ? 'On' : 'Off'}`; });
    retryBtn.addEventListener('click', () => initCam(facing));

    /* ---------- Geolocation ---------- */
    let pos = { lat: null, lng: null };
    navigator.geolocation.watchPosition(
      p => { pos = p.coords; },
      e => console.error(e),
      { enableHighAccuracy: true }
    );

    /* ---------- Capture ---------- */
    let stampedBlob = null;
    snapBtn.onclick = () => {
      const canvas = document.createElement('canvas');
      canvas.width = view.videoWidth;
      canvas.height = view.videoHeight + 60;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(view, 0, 0, canvas.width, canvas.height - 60);
      ctx.fillStyle = 'rgba(0,0,0,.7)';
      ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
      ctx.fillStyle = '#4cc9f0';
      ctx.font = '16px monospace';
      ctx.fillText(`${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, canvas.height - 35);
      if (pos.lat) ctx.fillText(`Lat: ${pos.lat.toFixed(5)}, Lng: ${pos.lng.toFixed(5)}`, 20, canvas.height - 10);
      canvas.toBlob(blob => { stampedBlob = blob; formArea.style.display = 'block'; snapBtn.style.display = 'none'; }, 'image/jpeg', 0.92);
    };

    /* ---------- Save ---------- */
    document.getElementById('save').onclick = () => {
      if (!stampedBlob) { document.getElementById('msg').textContent = 'No photo captured!'; return; }
      const num = document.getElementById('num').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const notes = document.getElementById('notes').value.trim();
      if (!num || !desc) { document.getElementById('msg').textContent = 'Asset number and description required!'; return; }
      const tx = db.transaction([storeName], 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.add({ num, desc, notes, img: stampedBlob, lat: pos.lat, lng: pos.lng, ts: new Date().toISOString() });
      req.onsuccess = () => {
        document.getElementById('msg').textContent = `Asset #${req.result} saved!`;
        updateRecordCount();
        setTimeout(() => {
          formArea.style.display = 'none';
          snapBtn.style.display = 'block';
          ['num', 'desc', 'notes'].forEach(id => document.getElementById(id).value = '');
          document.getElementById('msg').textContent = '';
        }, 1500);
      };
      req.onerror = () => document.getElementById('msg').textContent = 'Error saving asset!';
    };

    /* ---------- Export ---------- */
    document.getElementById('exportCSV').onclick = () => {
      if (!db) { alert('Database not available'); return; }
      const tx = db.transaction([storeName], 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => {
        const rows = req.result;
        if (!rows.length) { alert('No assets to export'); return; }
        let csv = 'ID,Asset Number,Description,Notes,Latitude,Longitude,Timestamp\n';
        rows.forEach(r => csv += `${r.id},"${r.num}","${r.desc}","${r.notes.replace(/"/g,'""')}",${r.lat ?? ''},${r.lng ?? ''},"${r.ts}"\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `asset-export-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      };
    };

    document.getElementById('exportImages').onclick = () => {
      if (!db) { alert('Database not available'); return; }
      const tx = db.transaction([storeName], 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => {
        const rows = req.result;
        if (!rows.length) { alert('No images to export'); return; }
        const overlay = document.getElementById('progressOverlay');
        const counter = document.getElementById('progressCounter');
        overlay.style.display = 'flex';
        let done = 0;
        const total = rows.length;
        function process(i) {
          if (i >= total) { overlay.style.display = 'none'; alert(`Exported ${total} images`); return; }
          counter.textContent = `${i + 1}/${total}`;
          const url = URL.createObjectURL(rows[i].img);
          const a = document.createElement('a');
          a.href = url;
          a.download = `asset-${rows[i].id}-${rows[i].num || 'unknown'}.jpg`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); process(i + 1); }, 150);
        }
        process(0);
      };
    };
  </script>
</body>
</html>
